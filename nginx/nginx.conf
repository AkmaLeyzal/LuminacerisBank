# nginx/nginx.conf

worker_processes auto;

events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    sendfile        on;
    keepalive_timeout  65;

    # Logging
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    # Gzip Compression
    gzip on;
    gzip_types text/plain application/xml text/css application/javascript;

    server {
        listen 80;
        server_name yourdomain.com;  # Ganti dengan domain Anda

        # Redirect HTTP ke HTTPS (Jika menggunakan SSL)
        # Uncomment block berikut jika Anda menggunakan SSL
        # return 301 https://$host$request_uri;

        # Routing untuk setiap microfrontend
        # 1. Login Page
        location /login_page/ {
            alias /usr/share/nginx/html/login_page/;
            try_files $uri /login_page/index.html;
        }

        # 2. Home Page
        location /home_page/ {
            alias /usr/share/nginx/html/home_page/;
            try_files $uri /home_page/index.html;
        }

        # 3. Card Management Page
        location /cardManagement_page/ {
            alias /usr/share/nginx/html/cardManagement_page/;
            try_files $uri /cardManagement_page/index.html;
        }

        # 4. Fraud Alert Page
        location /fraudAlert_page/ {
            alias /usr/share/nginx/html/fraudAlert_page/;
            try_files $uri /fraudAlert_page/index.html;
        }

        # 5. History Page
        location /history_page/ {
            alias /usr/share/nginx/html/history_page/;
            try_files $uri /history_page/index.html;
        }

        # 6. Loan Page
        location /loan_page/ {
            alias /usr/share/nginx/html/loan_page/;
            try_files $uri /loan_page/index.html;
        }

        # 7. Notification Center Page
        location /notificationCenter_page/ {
            alias /usr/share/nginx/html/notificationCenter_page/;
            try_files $uri /notificationCenter_page/index.html;
        }

        # 8. Payment Service Page
        location /paymentService_page/ {
            alias /usr/share/nginx/html/paymentService_page/;
            try_files $uri /paymentService_page/index.html;
        }

        # 9. Profile & Settings Page
        location /profileSetting_page/ {
            alias /usr/share/nginx/html/profileSetting_page/;
            try_files $uri /profileSetting_page/index.html;
        }

        # 10. Support Page
        location /support_page/ {
            alias /usr/share/nginx/html/support_page/;
            try_files $uri /support_page/index.html;
        }

        # 11. Transfer Page
        location /transfer_page/ {
            alias /usr/share/nginx/html/transfer_page/;
            try_files $uri /transfer_page/index.html;
        }

        # Proxy untuk API Microservices
        # 1. Auth Service
        location /api/auth/ {
            proxy_pass http://auth_service:8000/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Authorization $http_authorization;
        }

        # 2. User Management Service
        location /api/user_management/ {
            proxy_pass http://user_management_service:8000/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Authorization $http_authorization;
        }

        # 3. Account Service
        location /api/account/ {
            proxy_pass http://account_service:8000/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Authorization $http_authorization;
        }

        # 4. Transaction Service
        location /api/transaction/ {
            proxy_pass http://transaction_service:8000/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Authorization $http_authorization;
        }

        # 5. Payment Service
        location /api/payment/ {
            proxy_pass http://payment_service:8000/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Authorization $http_authorization;
        }

        # 6. Card Management Service
        location /api/card_management/ {
            proxy_pass http://card_management_service:8000/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Authorization $http_authorization;
        }

        # 7. Loan Service
        location /api/loan/ {
            proxy_pass http://loan_service:8000/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Authorization $http_authorization;
        }

        # 8. Notification Service
        location /api/notification/ {
            proxy_pass http://notification_service:8000/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Authorization $http_authorization;
        }

        # 9. Audit Service
        location /api/audit/ {
            proxy_pass http://audit_service:8000/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Authorization $http_authorization;
        }

        # 10. Fraud Detection Service
        location /api/fraud_detection/ {
            proxy_pass http://fraud_detection_service:8000/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Authorization $http_authorization;
        }

        # 11. Support Service
        location /api/support/ {
            proxy_pass http://support_service:8000/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Authorization $http_authorization;
        }

        # Mengatur cache untuk file statis
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
            expires 1h;
            add_header Cache-Control "public, no-transform";
        }

        # Mengamankan akses ke direktori tersembunyi
        location ~ /\. {
            deny all;
        }

        # Handling WebSocket (Jika diperlukan)
        # location /ws/ {
        #     proxy_pass http://your_websocket_service/;
        #     proxy_http_version 1.1;
        #     proxy_set_header Upgrade $http_upgrade;
        #     proxy_set_header Connection "upgrade";
        #     proxy_set_header Host $host;
        #     proxy_set_header X-Real-IP $remote_addr;
        #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        #     proxy_set_header X-Forwarded-Proto $scheme;
        # }
    }
}
